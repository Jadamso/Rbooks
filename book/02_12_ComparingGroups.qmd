# Comparing Groups
***


## Group Differences

For mixed data, $\hat{Y}_{i}$ is a cardinal variable and $\hat{X}_{i}$ is a factor variable (typically unordered). For such "grouped data", we analyze associations via group comparisons. The basic idea is best seen in a comparison of two samples, which corresponds to an $\hat{X}_{i}$ with two categories. For example, the heights of men and women in Canada or the homicide rates in two different American states.


We will consider the wages for people with and without completing a degree. To have this data on our computer, we must first install the "wooldridge" package once. Then we can access the data at any time by loading the package.

```{r, eval=FALSE}
# Install R Data Package and Load in
install.packages('wooldridge') # only once
library('wooldridge') # "load" anytime you want to use the data
?wooldridge # details about the package
?wage1 # details about the dataset we want
```

To compare wages for people with and without completing a degree, we start by making a [histogram](https://jadamso.github.io/Rbooks/01_02_Data.html#histogram-density-estimate) for both groups.

```{r}
library('wooldridge')
## Group 1
X1_id <- wage1[,'educ'] == 15
Y1 <- wage1[X1_id, 'wage']
## Group 2
X2_id <- wage1[,'educ'] == 16
Y2 <- wage1[X2_id, 'wage']

# Initial Summary Figure
bks <- seq(0, 24, by=1.5)
dlim <- c(0,.2)
cols <- c(rgb(1,0,0,.5), rgb(0,0,1,.5))

hist(Y1, breaks=bks, ylim=dlim,
     col=cols[1], xlab='Wages',
     freq=F, border=NA, main='')
hist(Y2, breaks=bks, ylim=dlim,
     col=cols[2],
     freq=F, border=NA, add=T)
legend('topright',
       col=cols, pch=15,
       legend=c('15 Years', '16 Years'),
       title='School Completed')
```

The histogram may show several differences between groups or none at all. Often, the first statistic we investigate for hypothesis testing is the mean.

#### **Mean Differences**. {-}

We often want to know if the means of different samples are the same or different. To test this hypothesis, we compute the means separately for each sample and then examine the differences term
\begin{eqnarray} 
\hat{D} = \hat{M}_{Y1} - \hat{M}_{Y2},
\end{eqnarray}
with a null hypothesis that there is no difference in the population means.

:::{.callout-note icon=false collapse="true"}
```{r}
# Differences between means
m1 <- mean(Y1)
m2 <- mean(Y2)
d <- m1-m2
    
# Bootstrap Distribution
bootstrap_diff <- vector(length=9999)
for(b in seq(bootstrap_diff) ){
    Y1_b <- sample(Y1, replace=T)
    Y2_b <- sample(Y2, replace=T)
    m1_b <- mean(Y1_b)
    m2_b <- mean(Y2_b)
    d_b <- m1_b - m2_b
    bootstrap_diff[b] <- d_b
}
hist(bootstrap_diff,
    border=NA, font.main=1,
    main='Difference in Means')

# 2-Sided Test via Confidence Interval
boot_ci <- quantile(bootstrap_diff, probs=c(.025, .975))
abline(v=boot_ci, lwd=2)
abline(v=0, lwd=2, col=2)
```
:::

Just as with one sample tests, we can compute a *standardized differences*, where $D$ is converted into a $t$ statistic. Note, however, that we have to compute the standard error for the difference statistic, which is a bit more complicated. However, this allows us to easily conduct one or two sided hypothesis tests using a standard normal approximation.

:::{.callout-tip icon=false collapse="true"}
```{r, eval=F}
se_hat <- sqrt(var(Y1)/n1 + var(Y2)/n2);
t_obs <- d/se_hat

t_2sample <- function(Y1, Y2){
    # Differences between means
    m1 <- mean(Y1)
    m2 <- mean(Y2)
    d <- (m1-m2)

    # SE estimate
    n1  <- length(Y1)
    n2  <- length(Y2)
    s1  <- var(Y1)
    s2  <- var(Y2)
    s   <- ((n1-1)*s1 + (n2-1)*s2)/(n1+n2-2)
    d_se <- sqrt(s*(1/n1+1/n2))

    # t stat
    t_stat <- d/d_se
    return(t_stat)
}
 
tstat <- twosam(data[,'male'], data[,'female'])
tstat
```
:::


#### **Quantile Differences**. {-}
The above procedure generalized from differences in means to other quantiles statistics like medians. To start, we plot the [ECDF](
https://jadamso.github.io/Rbooks/docs/01_02_Data.html#empirical-cumulative-distribution-function)'s for both groups.

```{r}
# Quantile Comparison

## Distribution 1
F1 <- ecdf(Y1)
plot(F1, col=cols[1],
     pch=16, xlab='Wages',
     main='Comparing Medians',
     font.main=1, bty='n')
## Median 1
med1 <- quantile(F1, probs=0.5)
segments(med1, 0, med1, 0.5, col=cols[1], lty=2)
abline(h=0.5, lty=2)

## Distribution 2
F2 <- ecdf(Y2)
plot(F2, add=TRUE, col=cols[2], pch=16)
## Median 2
med2 <- quantile(F2, probs=0.5)
segments(med2, 0, med2, 0.5, col=cols[2], lty=2)

## Legend
legend('bottomright',
       col=cols, pch=15,
       legend=c('Grade 15', 'Grade 16'),
       title='School Completed')

```

:::{.callout-note icon=false collapse="true"}
```{r}
# Bootstrap Distribution Function
boot_quant <- function(Y1, Y2, B=9999, probs=0.5, ...){
    bootstrap_diff <- vector(length=B)
    for(b in seq(bootstrap_diff)){
        Y1_b <- sample(Y1, replace=T)
        Y2_b <- sample(Y2, replace=T)
        q1_b <- quantile(Y1_b, probs=probs, ...)
        q2_b <- quantile(Y2_b, probs=probs, ...)
        d_b <- q1_b - q2_b
        bootstrap_diff[b] <- d_b
    }
    return(bootstrap_diff)
}

# 2-Sided Test for Median Differences
# d <- quantile(Y2, probs=0.5) - quantile(Y1, probs=0.5)
boot_d <- boot_quant(Y1, Y1, B=999, probs=0.5)
hist(boot_d, border=NA, font.main=1,
    main='Difference in Medians')
abline(v=quantile(boot_d, probs=c(.025, .975)), lwd=2)
abline(v=0, lwd=2, col=2)
1 - ecdf(boot_d)(0)
```
:::

The above procedure is quite general and extends  to other quantiles. Note that bootstrap tests can perform poorly with highly unequal variances or skewed data. To see this yourself, make a simulation with skewed data and unequal variances.


If we want to test for the differences in medians across groups with independent observations, we can also use notches in the boxplot. If the notches of two boxes do not overlap, then there is rough evidence that the difference in medians is statistically significant. The square root of the sample size is also shown as the bin width in each boxplot.^[Let each group $g$ have median $\tilde{M}_{g}$, interquartile range $\hat{IQR}_{g}$, observations $n_{g}$. We can compute standard deviation of the median as $\tilde{S}_{g}= \frac{1.25 \hat{IQR}_{g}}{1.35 \sqrt{n_{g}}}$. As a rough guess, the interval $\tilde{M}_{g} \pm 1.7 \tilde{S}_{g}$ is the historical default and displayed as a *notch* in the boxplot. See also <https://www.tandfonline.com/doi/abs/10.1080/00031305.1978.10479236>.]

```{r}
boxplot(Y1, Y2,
    col=cols,
    notch=T,
    varwidth=T)
```

In principle, we can also examine whether there are differences in spread (`sd` or `IQR`) or shape (`skew` or `kurtosis`). More often, however, we examine whether there are any differences in the distributions.

:::{.callout-tip icon=false collapse="true"}
Here is an example to look at differences in "spread"
```{r, eval=F}
boot_fun <- function( fun, B=9999, ...){
    bootstrap_diff <- vector(length=B)
    for(b in seq(bootstrap_diff)){
        Y1_b <- sample(Y1, replace=T)
        Y2_b <- sample(Y2, replace=T)
        f1_b <- fun(Y1_b, ...)
        f2_b <- fun(Y2_b, ...)
        d_b <- f1_b - f2_b
        bootstrap_diff[b] <- d_b
    }
    return(bootstrap_diff)
}

# 2-Sided Test for SD Differences
#d <- sd(Y2) - sd(Y1)
boot_d <- boot_fun(sd)
hist(boot_d, border=NA, font.main=1,
    main='Difference in Standard Deviations')
abline(v=quantile(boot_d, probs=c(.025, .975)), lwd=2)
abline(v=0, lwd=2, col=2)
1 - ecdf(boot_d)(0)


# Try any function!
# boot_fun( function(xs) { IQR(xs)/median(xs) } )
```
:::



## Distributional Comparisons

We can also examine whether there are any differences between the entire *distributions*. We typically start by plotting the data using ECDF's or a boxplot, and then calculate a statistic for hypothesis testing. Which plot and test statistic depends on how many groups there are.

#### **Two groups**.{-}

One useful visualization for two groups is to plot the quantiles against one another: a quantile-quantile plot. I.e., the first data point on the bottom left shows the first quantile for both distributions. 

```{r}
# Wage Data (same as from before)
#library(wooldridge)
#Y1 <- sort( wage1[wage1[,'educ'] == 15,  'wage'])  
#Y2 <- sort( wage1[wage1[,'educ'] == 16,  'wage'] )

# Compute Quantiles
quants <- seq(0,1,length.out=101)
Q1 <- quantile(Y1, probs=quants)
Q2 <- quantile(Y2, probs=quants)

# Compare Distributions via Quantiles
#ry <- range(c(Y1, Y2))
#plot(ry, c(0,1), type='n', font.main=1,
#    main='Distributional Comparison',
#    xlab="Quantile",
#    ylab="Probability")
#lines(Q1, quants, col=2)
#lines(Q2, quants, col=4)
#legend('bottomright', col=c(2,4), lty=1,
#	legend=c(
#	    expression(hat(F)[1]),
#	    expression(hat(F)[2]) 
#))

# Compare Quantiles
ry <- range(c(Y1, Y2))
plot(Q1, Q2, xlim=ry, ylim=ry,
    xlab=expression(Q[1]),
    ylab=expression(Q[2]),
    main='Quantile-Quantile Plot',
    font.main=1,
    pch=16, col=grey(0,.25))
abline(a=0,b=1,lty=2)
```

The starting point for hypothesis testing is the Kolmogorov-Smirnov Statistic: the maximum absolute difference between two CDF's over all sample data $y \in \{Y_1\} \cup \{Y_2\}$.
\begin{eqnarray}
\hat{KS} &=& \max_{y} |\hat{F}_{1}(y)- \hat{F}_{2}(y)|^{p},
\end{eqnarray}
where $p$ is an integer (typically 1). An intuitive alternative is the Cramer-von Mises Statistic: the sum of absolute differences (raised to an integer, typically 2) between two CDF's. 
\begin{eqnarray}
\hat{CVM} &=& \sum_{y} | \hat{F}_{1}(y)- \hat{F}_{2}(y)|^{p}.
\end{eqnarray}

```{r}
# Distributions
y <- sort(c(Y1, Y2))
F1 <- ecdf(Y1)(y)
F2 <- ecdf(Y2)(y)

library(twosamples)

# Kolmogorov-Smirnov
KSq <- which.max(abs(F2 - F1))
KSqv <- round(twosamples::ks_stat(Y1, Y2),2)

# Cramer-von Mises Statistic (p=2)
CVMqv <- round(twosamples::cvm_stat(Y1, Y2, power=2), 2) 

# Visualize Differences
plot(range(y), c(0,1), type="n", xlab='x', ylab='ECDF')
lines(y, F1, col=cols[1], lwd=2)
lines(y, F2, col=cols[2], lwd=2)

# KS
title( paste0('KS: ', KSqv), adj=0, font.main=1)
segments(y[KSq], F1[KSq], y[KSq], F2[KSq], lwd=1.5, col=grey(0,.75), lty=2)

# CVM
title( paste0('CVM: ', CVMqv), adj=1, font.main=1)
segments(y, F1, y, F2, lwd=.5, col=grey(0,.2))
```

Just as before, you use bootstrapping for hypothesis testing.
```{r}
twosamples::ks_test(Y1, Y2)

twosamples::cvm_test(Y1, Y2)
```

:::{.callout-tip icon=false collapse="true"}
Compare the distribution of arrests for two different counties, each with data over time.

```{r, eval=F}
library(wooldridge)
countymurders
```

:::

#### **Multiple groups**. {-}
With multiple groups, you will want to begin with a summary figure (such as a boxplot). We can also tests the equality of all distributions (whether at least one group is different). The *Kruskal-Wallis* test examines $H_0:\; F_1 = F_2 = \dots = F_G$ versus $H_A:\; \text{at least one } F_g \text{ differs}$, where $F_g$ is the continuous distribution of group $g=1,...G$. This test does not tell us which group is different.

To conduct the test, first denote individuals $i=1,...n$ with overall ranks $\hat{r}_1,....\hat{r}_{n}$. Each individual belongs to group $g=1,...G$, and each group $g$ has $n_{g}$ individuals with average rank $\bar{r}_{g} = \sum_{i} \hat{r}_{i} /n_{g}$. The Kruskal Wallis statistic is 
\begin{eqnarray}
\hat{KW} &=& (N-1) \frac{\sum_{g=1}^{G} n_{g}( \bar{r}_{g} - \bar{r}  )^2  }{\sum_{i=1}^{n} ( \hat{r}_{i} - \bar{r}  )^2}, 
\end{eqnarray}
where  $\bar{r} = \frac{n+1}{2}$ is the grand mean rank.

In the special case with only two groups, $G=2$, the Kruskal Wallis test reduces to the *Mannâ€“Whitney U* test (also known as the *Wilcoxon rank-sum* test). In this case, we can write the hypotheses in terms of individual outcomes in each group, $Y_i$ in one group $Y_j$ in the other; $H_0: Prob(Y_i > Y_j)=Prob(Y_i > Y_i)$  versus $H_A: Prob(Y_i > Y_j) \neq Prob(Y_i > Y_j)$. The corresponding test statistic is
\begin{eqnarray}
\hat{U}   &=& \min(\hat{U}_1, \hat{U}_2) \\
\hat{U}_g &=& \sum_{i\in g}\sum_{j\in -g}
           \Bigl[\mathbf 1( \hat{Y}_{i} > \hat{Y}_{j}) + \tfrac12\mathbf 1(\hat{Y}_{i} = \hat{Y}_{j})\Bigr].
\end{eqnarray}

```{r}
library(Ecdat)
data(Caschool)
Caschool[,'stratio'] <- Caschool[,'enrltot']/Caschool[,'teachers']

# Do student/teacher ratio differ for at least 1 county?
# Single test of multiple distributions
kruskal.test(Caschool[,'stratio'], Caschool[,'county'])

# Multiple pairwise tests
# pairwise.wilcox.test(Caschool[,'stratio'], Caschool[,'county'])
```


## Type II Errors

When we test a hypothesis, we start with a claim called the null hypothesis $H_0$ and an alternative claim $H_A$. Because we base conclusions on sample data, which has variability, mistakes are possible. There are two types of errors:

* *Type I Error*: Rejecting a true null hypothesis. (False Positive). 
* *Type II Error*: Failing to reject a false null hypothesis (False Negative). 

| True Situation | Decision: Fail to Reject $H_0$ | Decision: Reject $H_0$ |
|---|---|---|
| $H_0$ is True  |  Correct (no detection)  |  Type I Error (False Positive) |
| $H_0$ is False |  Type II Error (False Negative; missed detection) | Correct (effect detected) |

:::{.callout-tip icon=false collapse="true"}
Here is a Courtroom example: Someone suspected of committing a crime is at trial, and they are either guilty or not (a Bernoulli random variable). You hypothesize that the suspect is innocent, and a jury can either convict them (decide guilty) or free them (decide not-guilty). Recall that fail-to-reject a hypothesis does mean accepting it, so deciding not-guilty does not necessarily mean innocent.

| True Situation | Decision: Free | Decision: Convict |
|---|---|---|
| Suspect Innocent |  Correctly Freed  | Falsely Convicted |
| Suspect Guilty   |  Falsely Freed    | Correctly Convicted |
:::

#### **Statistical Power**. {-}

The probability of Type I Error is called *significance level* and denoted by $Prob(\text{Type I Error}) = \alpha$. The probability of correctly rejecting a false null is called *power* and denoted by $\text{Power} = 1 - \beta = 1 -  Prob(\text{Type II Error})$. 

Significance is often chosen by statistical analysts to be $\alpha=0.05$. Power is less often chosen, instead following from a decision about power.


:::{.callout-tip icon=false collapse="true"}
The code below runs a small simulation using a shifted, nonparametric bootstrap. Two-sided test; studentized statistic, for $H0: \mu = 0$

```{r power-sim, eval=F}
# Power for Two-sided test;
# nonparametric bootstrap, studentized statistic
n <- 25
mu <- 0
alpha <- 0.05
B <- 299

sim_reps <- 100 

p_values <- vector(length=sim_reps)
for (i in seq(p_values)) {
    # Generate data
    X <- rnorm(n, mean=0.2, sd=1)
    # Observed statistic
    X_bar <- mean(X)
    T_obs <-  (X_bar - mu) / (sd(X)/ sqrt(n)) ##studentized
    # Bootstrap null distribution of the statistic
    T_boot <- vector(length=B)
    X_null <- X - X_bar + mu # Impose the null by recentering
    for (b in seq(T_boot)) {
      X_b <- sample(X_null, size = n, replace = TRUE)
      T_b <- (mean(X_b) - mu) / (sd(X_b)/sqrt(n))
      T_boot[b] <- T_b
    }
    # Two-sided bootstrap p-value
    pval <- mean(abs(T_boot) >= abs(T_obs))
    p_values[i] <- pval
    }
power <- mean(p_values < alpha)
power
```
:::

There is an important Trade-off for fixed sample sizes: Increasing significance (fewer false positive) often lowers power (more false negatives). Generally, power depends on the effect size and sample size: bigger true effects and larger $n$ make it easier to detect real differences (higher power, lower $\beta$).



## Further Reading 

Other Statistics 

* <https://cran.r-project.org/web/packages/qualvar/vignettes/wilcox1973.html>


